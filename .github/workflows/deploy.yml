name: Deploy PCS Booking System v2.0.0 to Cloudflare Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  CLOUDFLARE_PROJECT_NAME: 'pcs-booking'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy PCS Booking System v2.0.0

    # Only deploy on push to main/master, not on PRs
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ” Verify Cloudflare secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN secret is not set"
            echo "Please add your Cloudflare API token to repository secrets"
            exit 1
          fi
          if [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "âŒ CLOUDFLARE_ACCOUNT_ID secret is not set"
            echo "Please add your Cloudflare Account ID to repository secrets"
            exit 1
          fi
          echo "âœ… All required Cloudflare secrets are configured"

      - name: ğŸ“‹ Display build information
        run: |
          echo "ğŸ—ï¸ Building PCS Booking System v2.0.0"
          echo "ğŸ“¦ Project: ${{ env.CLOUDFLARE_PROJECT_NAME }}"
          echo "ğŸŒ Target URL: https://${{ env.CLOUDFLARE_PROJECT_NAME }}.pages.dev"
          echo "ğŸ“ Source: packages/client"
          echo "ğŸ”§ Node.js: ${{ env.NODE_VERSION }}"

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing PCS Booking System dependencies..."
          npm install
          echo "âœ… Dependencies installed successfully"
          echo ""
          echo "ğŸ“‹ Key dependencies:"
          npm list @supabase/supabase-js || echo "âš ï¸ @supabase/supabase-js not found"
          npm list framer-motion || echo "âš ï¸ framer-motion not found"
          npm list react-slick || echo "âš ï¸ react-slick not found"
          npm list slick-carousel || echo "âš ï¸ slick-carousel not found"
          npm list terser || echo "âš ï¸ terser not found, using esbuild for minification"
          npm list tailwindcss || echo "âš ï¸ tailwindcss not found"
        working-directory: packages/client

      - name: ğŸ”§ Build PCS Booking System v2.0.0
        run: |
          echo "ğŸ”§ Building production bundle..."
          npm run build
          echo "âœ… Build completed successfully"
        working-directory: packages/client
        env:
          NODE_ENV: production
          VITE_APP_VERSION: "2.0.0"

      - name: âœ… Verify build output
        run: |
          if [ ! -d "packages/client/dist" ]; then
            echo "âŒ Build failed - dist directory not found"
            exit 1
          fi

          echo "âœ… Build successful - analyzing output:"
          echo "ğŸ“ Build directory contents:"
          ls -la packages/client/dist/
          echo ""
          echo "ğŸ“Š Build size analysis:"
          du -sh packages/client/dist/*
          echo ""
          echo "ğŸ” Checking for essential files:"
          [ -f "packages/client/dist/index.html" ] && echo "âœ… index.html found" || echo "âŒ index.html missing"
          [ -f "packages/client/dist/booking-ui.js" ] && echo "âœ… booking-ui.js found" || echo "âŒ booking-ui.js missing"
          [ -f "packages/client/dist/booking-ui.css" ] && echo "âœ… booking-ui.css found" || echo "âŒ booking-ui.css missing"

      - name: ğŸ› ï¸ Install Wrangler CLI
        run: |
          echo "ğŸ› ï¸ Installing Wrangler CLI..."
          npm install -g wrangler@3
          wrangler --version
          echo "âœ… Wrangler CLI installed successfully"

      - name: ğŸš€ Deploy to Cloudflare Pages
        run: |
          echo "ğŸš€ Deploying PCS Booking System v2.0.0 to Cloudflare Pages..."
          cd packages/client

          # Deploy with Wrangler CLI (creates project automatically if needed)
          wrangler pages deploy dist \
            --project-name="${{ env.CLOUDFLARE_PROJECT_NAME }}" \
            --compatibility-flags="nodejs_compat" \
            --compatibility-date="2024-01-01"

          echo "âœ… Deployment completed successfully!"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: ğŸ‰ Deployment Success Summary
        run: |
          echo "ğŸ‰ PCS Booking System v2.0.0 deployed successfully!"
          echo ""
          echo "ğŸ“± Live Application:"
          echo "   https://${{ env.CLOUDFLARE_PROJECT_NAME }}.pages.dev"
          echo ""
          echo "ğŸŒ Custom Domain Setup:"
          echo "   wrangler pages domain add ${{ env.CLOUDFLARE_PROJECT_NAME }} booking.privatecarserviceparis.com"
          echo ""
          echo "ğŸ“‹ Cloudflare Dashboard:"
          echo "   https://dash.cloudflare.com/pages/view/${{ env.CLOUDFLARE_PROJECT_NAME }}"
          echo ""
          echo "âœ¨ Features Deployed:"
          echo "   âœ… Luxury Vehicle Selection with Brand Filtering"
          echo "   âœ… International Phone Input with Country Detection"
          echo "   âœ… Mobile-First Increment/Decrement Inputs"
          echo "   âœ… Airport Transfer Forms with Flight Details"
          echo "   âœ… Birthday Decoration Themes by Age Group"
          echo "   âœ… Entertainment Services with Age Verification"
          echo "   âœ… Multi-Step Booking Process"
          echo "   âœ… WordPress Plugin Integration via window.PCS_CFG"
          echo "   âœ… Supabase Backend Integration"
          echo "   âœ… Responsive Luxury Design"
          echo ""
          echo "ğŸ”§ WordPress Plugin Configuration:"
          echo "   - Ensure SUPABASE_URL and SUPABASE_ANON_KEY are configured"
          echo "   - Deploy Supabase Edge Functions for backend"
          echo "   - Test booking form integration"
          echo ""
          echo "ğŸš€ Ready for production use!"

  # Build-only job for PRs (no deployment)
  build-test:
    runs-on: ubuntu-latest
    name: Build Test (PR)

    # Only run on PRs
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: npm install
        working-directory: packages/client

      - name: ğŸ”§ Build test
        run: npm run build
        working-directory: packages/client
        env:
          NODE_ENV: production

      - name: âœ… Build verification
        run: |
          echo "âœ… PR build test completed successfully"
          echo "ğŸ“ Build output verified"
          ls -la packages/client/dist/
